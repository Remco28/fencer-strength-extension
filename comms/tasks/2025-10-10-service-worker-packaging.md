# Task: Service Worker Packaging Fix

**Owner:** Architect  
**Status:** Ready for Implementation  
**Priority:** Release Blocker › Packaging

## Objective
Restore Manifest V3 service worker startup when the extension is installed from a packaged `.zip`. The current archive omits the `src/` helper modules, so `background.js` fails its `importScripts(...)` bootstrap and Chrome reports Status Code 15. We need a deterministic packaging flow that ships all required files and adds guardrails so future zips do not regress.

## Context
- Background service worker imports seven helper scripts from `src/` (config, cache, utils, API clients). Those files exist in the repository but were not included in the distributed archive.
- When any dependency is missing, `importScripts` throws a network error before our initialization logic runs, producing the observed console errors.
- `NEXT_STEPS.md` already calls out “Package for Distribution” as the last blocker before launch.

## Scope & Constraints
- Focus on packaging/distribution assets plus defensive logging. Do **not** refactor the helper modules themselves.
- The solution must work on macOS/Linux without additional dependencies beyond the system utilities we already rely on (bash, `zip`, `find`).
- Keep the zip contents flat (no additional parent directory) so Chrome sees `manifest.json` at the archive root.
- Avoid introducing a Node-based build unless absolutely necessary; a bash script is preferred for now.

## Required Changes
1. **Create deterministic packaging script (`scripts/package-extension.sh`)**
   - Ensure the script:
     - Exits on error (`set -euo pipefail`) and runs from the repo root.
     - Creates/refreshes a `dist/` folder (clean out any previous build).
     - Copies the runtime assets into `dist/`:
       - Root JS/CSS/HTML: `manifest.json`, `background.js`, `content.js`, `popup.html`, `popup.js`, `modal.css`.
       - Support directories: `src/`, `icons/`, `fonts/`, `assets/` (needed by README screenshots) and any other runtime folders referenced by the manifest.
       - `README.md` is optional for the archive, but include a minimal `INSTALL.txt` generated by the script summarising install steps (see below).
     - Produces a release archive `dist/fencer-strength-extension.zip` with those files at the root (`zip -rq`).
     - Emits a SHA256 checksum file alongside the zip for integrity verification.
     - Writes a short `INSTALL.txt` into `dist/` with manual install instructions (copy the four-step sequence from README after it is updated).
   - Add inline comments explaining which files are essential so future maintainers can update the copy list safely.

2. **Improve service worker diagnostics (`background.js`)**
   - Wrap the existing `importScripts(...)` call in a `try/catch`.
   - On failure, log a single descriptive error that names the missing files and points to the new packaging script, then rethrow to preserve Chrome’s registration failure (so the extension still refuses to load if dependencies are missing).

3. **Documentation updates**
   - **`README.md`**: Add a “Manual Install from Release Zip” section that:
     - States the packaged artifact is `dist/fencer-strength-extension.zip`.
     - Provides the step-by-step Chrome install instructions (download, unzip or load unpacked, enable developer mode, etc.).
     - Mentions the packaging script (`./scripts/package-extension.sh`) and that it must be rerun after code changes before sharing a zip.
   - **`NEXT_STEPS.md`**: Mark “Package for Distribution” as complete once the implementation lands.
   - Optionally reference the checksum file so downstream users can verify downloads.

4. **Repository housekeeping**
   - Ensure `scripts/package-extension.sh` is executable and that `dist/` remains in `.gitignore`.
   - If additional temporary files are generated (e.g., `dist/INSTALL.txt`), make sure they are either ignored or cleaned by the script.

## Acceptance Criteria
- Running `./scripts/package-extension.sh` from a clean checkout produces `dist/fencer-strength-extension.zip` that contains all `src/**` helpers.
- Installing the produced zip in Chrome results in a service worker that registers without Status Code 15 errors and the background console remains free of missing-script logs.
- `background.js` prints a clear error message if a future archive omits any dependency.
- README documents the packaging workflow and manual install steps; `NEXT_STEPS.md` shows the packaging item as done.

## Validation
1. Run the packaging script and inspect the generated zip (`unzip -l dist/fencer-strength-extension.zip`) to confirm `src/config/base-url.js` and other helpers are present.
2. Load the generated archive in Chrome (Developer Mode → Load unpacked after unzipping, or pack/unpack via command line) and verify the service worker console initializes successfully.
3. Perform a fencer lookup to ensure runtime functionality remains unchanged.
4. Confirm the checksum matches the zip (`sha256sum dist/fencer-strength-extension.zip` vs. saved `.sha256` file).
